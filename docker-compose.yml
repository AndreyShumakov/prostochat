services:
  backend:
    build: ./backend
    container_name: prostochat-backend
    environment:
      - PORT=${PORT:-3081}
      - PROD_HOST=${PROD_HOST:-adminchat.prostodoska.ru}
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY:-}
      - CLAUDE_API_KEY=${CLAUDE_API_KEY:-}
      - LLM_PROVIDER=${LLM_PROVIDER:-openrouter}
      - LLM_MODEL=${LLM_MODEL:-anthropic/claude-3.5-sonnet}
    volumes:
      - mnesia_data:/app/mnesia
    networks:
      - web_proxy
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=web_proxy"

      # HTTP router (redirects to HTTPS)
      - "traefik.http.routers.prostochat-backend-http.rule=Host(`adminchat.prostodoska.ru`)"
      - "traefik.http.routers.prostochat-backend-http.entrypoints=web"
      - "traefik.http.routers.prostochat-backend-http.middlewares=redirect-to-https"

      # HTTPS router
      - "traefik.http.routers.prostochat-backend-https.rule=Host(`adminchat.prostodoska.ru`)"
      - "traefik.http.routers.prostochat-backend-https.entrypoints=websecure"
      - "traefik.http.routers.prostochat-backend-https.tls.certresolver=myresolver"
      - "traefik.http.routers.prostochat-backend-https.service=prostochat-backend-service"

      # Service definition
      - "traefik.http.services.prostochat-backend-service.loadbalancer.server.port=${PORT:-3081}"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${PORT:-3081}/health"]
      interval: 10s
      timeout: 5s
      retries: 3
    restart: unless-stopped

  frontend:
    build: ./frontend
    container_name: prostochat-frontend
    environment:
      - FRONTEND_HOST=chat.prostodoska.ru
      - BACKEND_HOST=adminchat.prostodoska.ru
      - BACKEND_URL=https://adminchat.prostodoska.ru
      - LLM_PROVIDER=${LLM_PROVIDER:-openrouter}
      - LLM_MODEL=${LLM_MODEL:-anthropic/claude-3.5-sonnet}
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY:-}
      - CLAUDE_API_KEY=${CLAUDE_API_KEY:-}
    networks:
      - web_proxy
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=web_proxy"

      # HTTP router (redirects to HTTPS)
      - "traefik.http.routers.prostochat-frontend-http.rule=Host(`chat.prostodoska.ru`)"
      - "traefik.http.routers.prostochat-frontend-http.entrypoints=web"
      - "traefik.http.routers.prostochat-frontend-http.middlewares=redirect-to-https"

      # HTTPS router
      - "traefik.http.routers.prostochat-frontend-https.rule=Host(`chat.prostodoska.ru`)"
      - "traefik.http.routers.prostochat-frontend-https.entrypoints=websecure"
      - "traefik.http.routers.prostochat-frontend-https.tls.certresolver=myresolver"
      - "traefik.http.routers.prostochat-frontend-https.service=prostochat-frontend-service"

      # Service definition
      - "traefik.http.services.prostochat-frontend-service.loadbalancer.server.port=80"
    depends_on:
      backend:
        condition: service_healthy
    restart: unless-stopped

networks:
  web_proxy:
    external: true

volumes:
  mnesia_data:
